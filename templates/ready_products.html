<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ready Products - TBM Inventory and Sells Tracker</title>
  <link rel="stylesheet" href="/static/main.css">
</head>
<body>

  <header class="site-header">
    <div class="logo">TBM</div>
    <div class="site-title">TBM Inventory and Sells Tracker</div>
    <nav class="site-nav">
      <a href="/" class="nav-home">Dashboard</a>
      <a href="/ready-products" class="nav-ready">Ready Products</a>
      <a href="/raw-materials" class="nav-raw">Raw Materials</a>
      <a href="/sales" class="nav-sales">Sales</a>
      <a href="/import" class="nav-import">CSV Import/Export</a>
    </nav>
  </header>

<div class="page-wrap">
  <h1>Ready Products</h1>
  <div class="section-nav">
    <a href="#ready-form">Add / Update</a>
    <a href="#ready-list">Inventory</a>
  </div>

  <section id="ready-form" class="card">
    <h2>Add / Update Ready Product</h2>
    <form id="rForm">
      <input name="id" type="hidden">
      <label>Name <input name="name" required></label>
      <label>Category
        <select name="category">
          <option>Home Delivery</option>
          <option>Frozen Products</option>
          <option>SFH</option>
        </select>
      </label>
      <label>Unit
        <select name="unit">
          <option>KG</option><option>GM</option><option>Pieces</option>
          <option>Batch</option><option>Plates</option><option>Portion</option>
        </select>
      </label>
      <label>Unit Cost <input name="unit_cost" type="number" step="0.01"></label>
      <label>Selling Price <input name="price" type="number" step="0.01"></label>
      <label>Stock <input name="quantity" type="number" step="0.001"></label>
      <label>Threshold <input name="threshold" type="number" step="0.001" value="0"></label>
      <button type="submit">Save</button>
      <button type="button" id="resetR">Reset</button>
    </form>
  </section>

  <section id="ready-list" class="card">
    <h2>Ready Product Inventory</h2>
    <div id="readyList"></div>
  </section>


  <div class="footer">
    TBM Inventory and Sells Tracker &mdash; CSV based, simple, fast. 
  </div>

</div>
<script src="/static/ui.js"></script>
<script>
  document.querySelector('.nav-ready').classList.add('active');

  const rForm = document.getElementById('rForm');
  const resetR = document.getElementById('resetR');
  const readyList = document.getElementById('readyList');

  resetR.onclick = () => { rForm.reset(); rForm.id.value = ''; };

  async function loadReady(){
    const data = await fetchJSON('/api/ready_products');
    const rows = data.rows || [];
    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Name</th><th>Category</th><th>Unit</th><th>Unit Cost</th><th>Price</th><th>Stock</th><th>Thr</th><th>Actions</th></tr>';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const low = Number(r.threshold||0) > 0 && Number(r.quantity||0) <= Number(r.threshold||0);
      if(low) tr.classList.add('warn');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.category}</td>
        <td>${r.unit || ''}</td>
        <td>${r.unit_cost}</td>
        <td>${r.price}</td>
        <td>${r.quantity}</td>
        <td>${r.threshold}</td>
        <td>
          <button data-id="${r.id}" class="edit">Edit</button>
          <button data-id="${r.id}" class="del">Delete</button>
        </td>`;
      table.appendChild(tr);
    });
    readyList.innerHTML = '';
    readyList.appendChild(table);

    table.onclick = async (e) => {
      const id = e.target.dataset.id;
      if(!id) return;
      if(e.target.classList.contains('edit')){
        const r = (rows||[]).find(x => x.id === id);
        if(!r) return;
        rForm.id.value = r.id;
        rForm.name.value = r.name;
        rForm.category.value = r.category;
        rForm.unit.value = r.unit || 'KG';
        rForm.unit_cost.value = r.unit_cost;
        rForm.price.value = r.price;
        rForm.quantity.value = r.quantity;
        rForm.threshold.value = r.threshold;
      } else if(e.target.classList.contains('del')) {
        if(confirm('Delete product?')){
          await fetchJSON('/api/ready_products/' + id, {method:'DELETE'});
          loadReady();
        }
      }
    };
  }

  rForm.onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
      name: rForm.name.value.trim(),
      category: rForm.category.value,
      unit: rForm.unit.value,
      unit_cost: Number(rForm.unit_cost.value || 0),
      price: Number(rForm.price.value || 0),
      quantity: Number(rForm.quantity.value || 0),
      threshold: Number(rForm.threshold.value || 0)
    };
    if(rForm.id.value){
      await fetchJSON('/api/ready_products/' + rForm.id.value, {
        method:'PUT', body: JSON.stringify(payload)
      });
    } else {
      await fetchJSON('/api/ready_products', {
        method:'POST', body: JSON.stringify(payload)
      });
    }
    rForm.reset(); rForm.id.value=''; loadReady();
  };

  loadReady();
</script>
</body>
</html>
