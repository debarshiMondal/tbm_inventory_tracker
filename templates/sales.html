<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales / POS - TBM Inventory and Sells Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/main.css">
  <style>
    :root{
      --accent:#c62828;
      --ink:#111;
      --muted:#666;
      --bg:#f5f5f5;
      --card:#fff;
      --ok:#2e7d32;
      --info:#1976d2;
      --warn:#ef6c00;
    }

    body{
      font-size:14px;
      color:var(--ink);
    }

    .site-header{ padding:10px 12px; gap:12px; }
    .site-title{ font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .site-nav{ overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; }
    .site-nav a{ padding-bottom:2px; }

    .section-nav{
      position:sticky; top:56px; z-index:15; background:var(--bg);
      padding:8px 0; margin:8px 0 12px; border-bottom:1px dashed #ddd;
      overflow-x:auto; white-space:nowrap;
    }
    .section-nav a{
      display:inline-block; margin-right:8px; font-size:12px; padding:6px 10px;
      border:1px solid #e0e0e0; border-radius:999px; background:#fff;
    }
    .section-nav a:hover{ border-color:var(--accent); color:var(--accent); }

    .card h2{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:16px;
    }

    .hint{
      color:var(--muted);
      font-size:11px;
    }

    .pos-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px 12px;
    }
    .field{ grid-column:span 12; }
    .field.w2{ grid-column:span 6; }
    .field.w3{ grid-column:span 12; }
    .field.w4{ grid-column:span 12; }
    .field.w6{ grid-column:span 12; }
    .field.w8{ grid-column:span 12; }
    .field.w12{ grid-column:span 12; }

    .field label{
      display:block;
      margin:0 0 4px 2px;
      font-size:12px;
      color:#444;
    }

    .field input,
    .field select,
    .field textarea{
      width:100%;
      height:40px;
      font-size:14px;
      padding:6px 10px;
    }

    .kpi{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid #eee;
      font-size:11px;
    }
    .kpi b{ color:var(--accent); }

    /* catalogue */
    .catalog-wrap{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .search-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .search-row input{
      flex:1;
      height:40px;
      border-radius:999px;
      border:1px solid #ddd;
      padding:6px 12px;
      font-size:14px;
    }
    .search-row button{
      height:36px;
      padding:0 14px;
      border-radius:999px;
      font-size:13px;
    }

    .cat-chips{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .cat-chip{
      flex:0 0 auto;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    .cat-chip.active{
      border-color:var(--accent);
      background:#ffecec;
      color:var(--accent);
    }

    .cat-search-row{
      margin-top:4px;
    }
    .cat-search-row input{
      height:34px;
      border-radius:999px;
      border:1px solid #eee;
      padding:4px 10px;
      font-size:12px;
    }

    .item-list{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:320px;
      overflow-y:auto;
    }
    .item-row{
      display:grid;
      grid-template-columns:minmax(0,1.6fr) auto;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      background:#fff;
      border-radius:10px;
      border:1px solid #eee;
    }
    .item-main{
      min-width:0;
    }
    .item-name{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-meta{
      font-size:11px;
      color:#777;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .item-ctrl{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    .btn-add{
      border-radius:999px;
      padding:6px 16px;
      font-size:12px;
      font-weight:600;
      background:#fff;
      border:1px solid var(--accent);
      color:var(--accent);
      cursor:pointer;
    }
    .btn-add:hover{
      background:var(--accent);
      color:#fff;
    }

    .qty-pill{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      border:1px solid #ddd;
      overflow:hidden;
      font-size:12px;
      background:#fff;
    }
    .qty-pill button{
      width:28px;
      height:30px;
      border:none;
      background:#fff;
      font-size:16px;
      line-height:1;
      cursor:pointer;
    }
    .qty-pill span{
      width:30px;
      text-align:center;
      font-weight:600;
    }

    /* order / bill palette */
    .order-pane,
    .checkout-pane{
      margin-top:10px;
      border-top:1px dashed #eee;
      padding-top:10px;
    }
    .order-pane h3,
    .checkout-pane h3{
      font-size:13px;
      margin:0 0 6px;
    }

    .bill-items{
      border-radius:10px;
      border:1px solid #eee;
      background:#fafafa;
      padding:6px 6px 4px;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:260px;
      overflow-y:auto;
    }
    .bill-items-empty{
      font-size:12px;
      color:#777;
      padding:4px 4px 6px;
    }
    .bill-line{
      background:#fff;
      border-radius:8px;
      border:1px solid #e0e0e0;
      padding:6px 8px;
      display:grid;
      grid-template-columns:minmax(0,1.6fr) auto;
      gap:6px;
      align-items:center;
    }
    .bill-line-title{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .bill-line-sub{
      font-size:11px;
      color:#777;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .bill-line-ctrl{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:4px;
    }
    .bill-line-ctrl .qty-pill button{
      height:28px;
      width:26px;
    }
    .disc-input{
      width:60px;
      height:28px;
      font-size:11px;
      padding:2px 4px;
    }
    .disc-label{
      font-size:10px;
      color:#777;
    }

    .totals{
      margin-top:6px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:4px;
      background:#fafafa;
      border-radius:8px;
      border:1px dashed #ddd;
      padding:8px 10px;
      font-size:12px;
    }
    .totals .v{ text-align:right; font-weight:600; }
    .totals .grand{ color:#000; font-size:15px; }

    .order-actions{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .order-actions button{
      flex:1;
      height:40px;
      border-radius:999px;
      font-size:13px;
    }

    .chipbar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:var(--accent);
      color:#fff;
      background:var(--accent);
    }

    .float-bar{
      position:sticky;
      bottom:0;
      z-index:20;
      background:rgba(255,255,255,.96);
      border-top:1px solid #eee;
      backdrop-filter: blur(5px);
      padding:6px 8px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
    }
    .float-bar .summary b{ color:#000; }
    .float-bar button{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      font-size:12px;
    }
    .btn-plain{
      background:#fff;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    .btn-plain:hover{
      background:var(--accent);
      color:#fff;
    }

    .hide-on-mobile{ display:none; }
    .show-on-mobile{ display:block; }

    /* status chips for report */
    .status-chip{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      font-weight:500;
    }
    .status-live{
      background:#fff3e0;
      color:#ef6c00;
    }
    .status-due{
      background:#ffebee;
      color:#c62828;
    }
    .status-paid{
      background:#e8f5e9;
      color:#2e7d32;
    }

    .table-cards{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .tcard{
      border:1px solid #eee;
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
    }
    .tcard h3{
      margin:0 0 6px;
      font-size:13px;
    }
    .tcard .count{
      font-size:18px;
      font-weight:700;
      color:var(--accent);
    }
    .tcard:hover{
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }

    .table-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-scroll table{ min-width:820px; }

    .col-chooser{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .col-chooser label{
      font-size:11px;
      border:1px solid #ddd;
      border-radius:999px;
      padding:4px 8px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .col-chooser input{ margin-right:4px; }

    button{
      height:40px;
      border-radius:8px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:80px;
      transform:translateX(-50%);
      background:#000;
      color:#fff;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:50;
    }
    .toast.show{
      opacity:0.95;
      transform:translateX(-50%) translateY(-6px);
    }

    @media (min-width:768px){
      .field.w2{ grid-column:span 2; }
      .field.w3{ grid-column:span 3; }
      .field.w4{ grid-column:span 4; }
      .field.w6{ grid-column:span 6; }
      .field.w8{ grid-column:span 8; }
      .field.w12{ grid-column:span 12; }

      .table-cards{ grid-template-columns:repeat(4,1fr); }

      .hide-on-mobile{ display:block; }
      .show-on-mobile{ display:none; }

      body{ font-size:14px; }
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="logo">TBM</div>
  <div class="site-title">TBM Inventory and Sells Tracker</div>
  <nav class="site-nav">
    <a href="/" class="nav-home">Dashboard</a>
    <a href="/ready-products" class="nav-ready">Ready Products</a>
    <a href="/raw-materials" class="nav-raw">Raw Materials</a>
    <a href="/sales" class="nav-sales">Sales</a>
    <a href="/import" class="nav-import">CSV Import/Export</a>
  </nav>
</header>

<div class="page-wrap">
  <h1>Sales / POS</h1>

  <div class="section-nav">
    <a href="#add">Add Sale</a>
    <a href="#live">Live Tables</a>
    <a href="#report">Sales Report</a>
  </div>

  <!-- =================== ADD SALE / POS =================== -->
  <section id="add" class="card">
    <h2>
      Add Sale
      <span class="kpi">Current Bill: <b id="billOrderLabel">#–</b></span>
    </h2>

    <!-- Top: Category / Branch / Date -->
    <div class="pos-grid" style="margin-bottom:6px;">
      <div class="field w4">
        <label>Category</label>
        <select id="saleCategory"></select>
        <div class="hint">Stays fixed for new bills until you change it.</div>
      </div>

      <div class="field w4" id="sfhBranchWrap" style="display:none;">
        <label>Branch (SFH)</label>
        <div style="display:flex; gap:8px;">
          <select id="branchSelect" style="flex:1 1 auto"></select>
          <button class="btn-plain" type="button" id="addBranchBtn">Add</button>
        </div>
        <div class="hint">Quickly add new SFH branches.</div>
      </div>

      <div class="field w4">
        <label>Date</label>
        <input id="saleDate" type="date">
      </div>
    </div>

    <!-- Step 1: Catalogue & item selection -->
    <div id="browsePane" class="catalog-wrap">
      <div class="search-row">
        <input id="saleItem" placeholder="Search by name or 3-char code (e.g. 1CM)…">
        <button type="button" id="searchAddBtn">Add</button>
      </div>
      <div class="hint">Type and hit Add/Enter to drop items directly into the order. Default quantity = 1.</div>

      <div class="cat-chips" id="itemCategoryChips">
        <!-- filled from ready products -->
      </div>

      <div class="cat-search-row">
        <input id="catSearchInput" placeholder="Search inside selected category…">
      </div>

      <div id="itemList" class="item-list">
        <!-- items appear here -->
      </div>
    </div>

    <!-- Step 2: Order view -->
    <div id="orderPane" class="order-pane" style="display:none;">
      <h3>Order Items</h3>
      <div id="billItems" class="bill-items">
        <div class="bill-items-empty">No items yet. Add from search or category list.</div>
      </div>
      <div class="totals">
        <div>Subtotal</div><div class="v" id="tSubtotal">₹0.00</div>
        <div>Total Discount</div><div class="v" id="tDiscount">₹0.00</div>
        <div class="grand">Grand Total</div><div class="v grand" id="tTotal">₹0.00</div>
      </div>
      <div class="order-actions">
        <button type="button" class="btn-plain" id="backToBrowseBtn">← Back to items</button>
        <button type="button" id="lockOrderBtn">Lock Order</button>
      </div>
    </div>

    <!-- Step 3: Checkout -->
    <div id="checkoutPane" class="checkout-pane" style="display:none;">
      <h3>Checkout</h3>

      <div class="pos-grid">
        <div class="field w12">
          <label>Order Type</label>
          <div class="chipbar" id="orderTypeChips">
            <div class="chip active" data-type="DineIn">Dine In</div>
            <div class="chip" data-type="Takeaway">Takeaway</div>
            <div class="chip" data-type="Delivery">Delivery</div>
          </div>
        </div>

        <div class="field w4" id="tableField">
          <label>Table Number (for Dine In, SFH)</label>
          <input id="saleTable" placeholder="">
        </div>

        <div class="field w4">
          <label>Customer Name</label>
          <input id="saleCustName" placeholder="">
        </div>

        <div class="field w4">
          <label>Customer Phone</label>
          <input id="saleCustPhone" placeholder="" inputmode="tel">
        </div>

        <div class="field w12">
          <label>Payment Status</label>
          <div class="chipbar" id="payChips">
            <div class="chip active" data-status="Live">Live</div>
            <div class="chip" data-status="Due">Due</div>
            <div class="chip" data-status="Paid">Paid</div>
          </div>
        </div>

        <div class="field w6" id="payModeRow" style="display:none;">
          <label>Payment Mode (if Paid)</label>
          <select id="payMode">
            <option value="">Select</option>
            <option value="CurrentUPI">Current a/c UPI</option>
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="PersonalUPI">Personal UPI</option>
            <option value="PersonalCash">Personal Cash</option>
          </select>
        </div>

        <div class="field w6" id="payNoteRow" style="display:none;">
          <label>Payment Note</label>
          <input id="payNote" placeholder="Owner / keeper (for Personal)">
        </div>

        <div class="field w12">
          <label>Notes (bill)</label>
          <input id="saleNotes" placeholder="Any remarks…">
        </div>
      </div>

      <div class="order-actions">
        <button type="button" class="btn-plain" id="backToOrderBtn">← Back to order</button>
        <button type="button" id="saveBillBtn">Save Bill &amp; Print</button>
      </div>
    </div>

    <!-- bottom sticky bar -->
    <div class="float-bar" id="floatBar">
      <div class="summary">
        Bill <b id="floatOrder">#–</b> • Items <b id="floatItems">0</b> • Total <b id="floatTotal">₹0.00</b>
      </div>
      <div style="display:flex; gap:6px;">
        <button type="button" class="btn-plain" id="clearFormBtn">New Bill</button>
        <button type="button" id="viewOrderBtn">View Order</button>
      </div>
    </div>

    <p class="hint">
      Flow: pick Category &amp; Branch → tap items like Blinkit (ADD / − 1 +) → View Order → Lock Order → choose Dine In / Takeaway / Delivery → set payment → Save &amp; Print.
    </p>
  </section>

  <!-- =================== LIVE TABLES (SFH) =================== -->
  <section id="live" class="card">
    <h2>Live Tables (SFH)</h2>
    <div class="pos-grid" style="margin-bottom:8px;">
      <div class="field w6">
        <label>Branch</label>
        <select id="liveBranch"></select>
      </div>
      <div class="field w6">
        <label>&nbsp;</label>
        <button id="refreshLive" class="btn-plain" type="button">Refresh</button>
      </div>
    </div>

    <div id="liveWrap">
      <div class="hint">Pick an SFH branch to see current live orders per table.</div>
    </div>
  </section>

  <!-- =================== SALES REPORT =================== -->
  <section id="report" class="card">
    <h2>Sales Records &amp; Report</h2>

    <div class="show-on-mobile hint" style="margin-bottom:8px;">
      Mobile view shows <b>Today</b> only for the currently selected Category / Branch.
    </div>

    <div class="pos-grid">
      <div class="field w3">
        <label>Period</label>
        <select id="rPeriod">
          <option value="last30">Last 30 days</option>
          <option value="last90">Last 90 days</option>
          <option value="last180">Last 180 days</option>
          <option value="month">This month</option>
          <option value="week">This week</option>
          <option value="today" selected>Today</option>
          <option value="daterange">Date range…</option>
        </select>
      </div>
      <div class="field w3 hide-on-mobile">
        <label>Start</label>
        <input id="rStart" type="date">
      </div>
      <div class="field w3 hide-on-mobile">
        <label>End</label>
        <input id="rEnd" type="date">
      </div>
      <div class="field w3 hide-on-mobile">
        <label>Category</label>
        <select id="rCategory">
          <option value="">(All)</option>
        </select>
      </div>
      <div class="field w4 hide-on-mobile">
        <label>Branch (SFH)</label>
        <input id="rBranch" placeholder="">
      </div>
      <div class="field w4 hide-on-mobile">
        <label>Item</label>
        <input id="rItem" placeholder="">
      </div>
      <div class="field w4 hide-on-mobile">
        <label>Status</label>
        <select id="rStatus">
          <option value="">(All)</option>
          <option>Live</option>
          <option>Due</option>
          <option>Paid</option>
        </select>
      </div>
      <div class="field w12">
        <button id="runReport" type="button">Run</button>
      </div>

      <!-- Mobile cash / summary box (kept from previous version) -->
      <div class="field w12 show-on-mobile">
        <div id="mobileCashBox" class="cashbox">
          <div class="cashbox-opening">
            <label for="openingCash">Opening Cash</label>
            <input id="openingCash" type="number" step="0.01" inputmode="decimal" placeholder="0.00">
          </div>
          <div class="cashbox-row"><span>Category</span><strong id="cbCategory">–</strong></div>
          <div class="cashbox-row"><span>Branch</span><strong id="cbBranch">–</strong></div>
          <div class="cashbox-row total-row"><span>Total Sales</span><strong id="cbTotalSales">₹0.00</strong></div>
          <div class="cashbox-row"><span>Due</span><strong id="cbDue">₹0.00</strong></div>
          <div class="cashbox-row"><span>Paid</span><strong id="cbPaid">₹0.00</strong></div>
          <hr>
          <div class="cashbox-row"><span>Cash</span><strong id="cbCash">₹0.00</strong></div>
          <div class="cashbox-row"><span>Current a/c UPI</span><strong id="cbCurrentUPI">₹0.00</strong></div>
          <div class="cashbox-row"><span>Card</span><strong id="cbCard">₹0.00</strong></div>
          <div class="cashbox-row"><span>Personal Cash</span><strong id="cbPersonalCash">₹0.00</strong></div>
          <div class="cashbox-row"><span>Personal UPI</span><strong id="cbPersonalUPI">₹0.00</strong></div>
          <div class="cashbox-settle">
            <button type="button" id="settlePersonalCashBtn" class="btn-plain">Settle Personal Cash → Cash</button>
            <button type="button" id="settlePersonalUPIBtn" class="btn-plain">Settle Personal UPI → Current UPI</button>
          </div>
        </div>
      </div>

      <div class="field w12">
        <div class="kpi" id="reportSummary">Total: ₹0.00</div>
      </div>

      <div class="field w12 hide-on-mobile">
        <label>Columns to show</label>
        <div id="detailColChooser" class="col-chooser"></div>
      </div>

      <div class="field w12 hide-on-mobile" id="detailBlock">
        <h3 style="margin:10px 0 6px;">Detailed Records</h3>
        <div class="table-scroll">
          <table id="tblDetail"></table>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">TBM Inventory and Sells Tracker — CSV based, simple, fast.</div>
</div>

<div id="toast" class="toast"></div>

<script src="/static/ui.js"></script>
<script>
  document.querySelector('.nav-sales')?.classList.add('active');

  // ---------- Elements ----------
  const billOrderLabel = document.getElementById('billOrderLabel');
  const floatOrder     = document.getElementById('floatOrder');
  const floatItems     = document.getElementById('floatItems');
  const floatTotal     = document.getElementById('floatTotal');

  const saleCategory   = document.getElementById('saleCategory');
  const sfhBranchWrap  = document.getElementById('sfhBranchWrap');
  const branchSelect   = document.getElementById('branchSelect');
  const addBranchBtn   = document.getElementById('addBranchBtn');
  const saleDate       = document.getElementById('saleDate');

  const saleItem       = document.getElementById('saleItem');
  const searchAddBtn   = document.getElementById('searchAddBtn');
  const itemCategoryChips = document.getElementById('itemCategoryChips');
  const catSearchInput = document.getElementById('catSearchInput');
  const itemList       = document.getElementById('itemList');

  const browsePane     = document.getElementById('browsePane');
  const orderPane      = document.getElementById('orderPane');
  const checkoutPane   = document.getElementById('checkoutPane');

  const billItemsEl    = document.getElementById('billItems');
  const tSub           = document.getElementById('tSubtotal');
  const tDisc          = document.getElementById('tDiscount');
  const tTotal         = document.getElementById('tTotal');

  const backToBrowseBtn = document.getElementById('backToBrowseBtn');
  const lockOrderBtn    = document.getElementById('lockOrderBtn');

  const orderTypeChips  = document.getElementById('orderTypeChips');
  const tableField      = document.getElementById('tableField');
  const saleTable       = document.getElementById('saleTable');
  const saleCustName    = document.getElementById('saleCustName');
  const saleCustPhone   = document.getElementById('saleCustPhone');
  const saleNotes       = document.getElementById('saleNotes');

  const payChips        = document.getElementById('payChips');
  const payModeRow      = document.getElementById('payModeRow');
  const payNoteRow      = document.getElementById('payNoteRow');
  const payMode         = document.getElementById('payMode');
  const payNote         = document.getElementById('payNote');

  const backToOrderBtn  = document.getElementById('backToOrderBtn');
  const saveBillBtn     = document.getElementById('saveBillBtn');

  const floatBar        = document.getElementById('floatBar');
  const clearFormBtn    = document.getElementById('clearFormBtn');
  const viewOrderBtn    = document.getElementById('viewOrderBtn');

  const liveBranch      = document.getElementById('liveBranch');
  const refreshLive     = document.getElementById('refreshLive');
  const liveWrap        = document.getElementById('liveWrap');

  const rPeriod         = document.getElementById('rPeriod');
  const rStart          = document.getElementById('rStart');
  const rEnd            = document.getElementById('rEnd');
  const rCategory       = document.getElementById('rCategory');
  const rBranch         = document.getElementById('rBranch');
  const rItem           = document.getElementById('rItem');
  const rStatus         = document.getElementById('rStatus');
  const runReportBtn    = document.getElementById('runReport');
  const reportSummary   = document.getElementById('reportSummary');
  const tblDetail       = document.getElementById('tblDetail');
  const detailColChooser= document.getElementById('detailColChooser');

  const mobileCashBox   = document.getElementById('mobileCashBox');
  const openingCashInput= document.getElementById('openingCash');
  const cbCategory      = document.getElementById('cbCategory');
  const cbBranch        = document.getElementById('cbBranch');
  const cbTotalSales    = document.getElementById('cbTotalSales');
  const cbDue           = document.getElementById('cbDue');
  const cbPaid          = document.getElementById('cbPaid');
  const cbCash          = document.getElementById('cbCash');
  const cbCurrentUPI    = document.getElementById('cbCurrentUPI');
  const cbCard          = document.getElementById('cbCard');
  const cbPersonalCash  = document.getElementById('cbPersonalCash');
  const cbPersonalUPI   = document.getElementById('cbPersonalUPI');
  const settlePersonalCashBtn = document.getElementById('settlePersonalCashBtn');
  const settlePersonalUPIBtn  = document.getElementById('settlePersonalUPIBtn');

  const toastEl         = document.getElementById('toast');

  // ---------- State ----------
  const DEFAULT_CATEGORIES = ['Home Delivery','Frozen Products','SFH'];
  const PAYMENT_STATUSES   = ['Live','Due','Paid'];
  const PAYMENT_MODES      = ['', 'CurrentUPI','Cash','Card','PersonalUPI','PersonalCash'];

  let readyRows = [];
  let readyIndexByName = {}; // name_lower -> info
  let readyIndexByCode = {}; // code_upper -> info
  let allCategories = new Set();
  let itemCategories = [];   // from item_category

  let currentItemCategory = ''; // item_category selected
  let currentItemFilter   = ''; // inside-category search

  let billItems = [];  // [{name, code, item_category, unit, qty, unit_price, discount}]
  let payStatus = 'Live';
  let orderType = 'DineIn'; // DineIn / Takeaway / Delivery
  let nextOrderId = 1;

  let lastReportData = null;
  let currentReportRows = [];
  let visibleDetailCols = new Set();
  let openingCashKey = null;

  const detailColumns = [
    { key: 'date',           label: 'Date' },
    { key: 'category',       label: 'Category' },
    { key: 'branch',         label: 'Branch' },
    { key: 'order_id',       label: 'Order' },
    { key: 'item',           label: 'Item' },
    { key: 'unit',           label: 'Unit' },
    { key: 'qty',            label: 'Qty' },
    { key: 'unit_price',     label: 'Unit Price' },
    { key: 'discount',       label: 'Discount' },
    { key: 'total_price',    label: 'Total' },
    { key: 'customer_name',  label: 'Customer' },
    { key: 'customer_phone', label: 'Phone' },
    { key: 'table_no',       label: 'Table' },
    { key: 'payment_status', label: 'Status' },
    { key: 'payment_mode',   label: 'Mode' },
    { key: 'payment_note',   label: 'Pay Note' },
    { key: 'notes',          label: 'Notes' },
  ];
  visibleDetailCols = new Set(detailColumns.map(c => c.key));

  // ---------- Utils ----------
  const toMoney = (n)=> '₹' + (Number(n||0).toFixed(2));
  const isMobile = ()=> window.matchMedia('(max-width: 767px)').matches;

  function showToast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 1700);
  }

  async function fetchJSON(url, opts){
    const res = await fetch(url, Object.assign({
      headers:{'Content-Type':'application/json'}
    }, opts || {}));
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function isThreeCharCode(v){
    return /^[0-9][A-Za-z]{2}$/.test((v||'').trim());
  }

  function updateOrderLabels(){
    billOrderLabel.textContent = '#' + nextOrderId;
    floatOrder.textContent     = '#' + nextOrderId;
  }

  function reserveOrderId(){
    const id = nextOrderId;
    nextOrderId += 1;
    localStorage.setItem('tbm_last_order_id', String(id));
    updateOrderLabels();
    return String(id);
  }

  function setChipsActive(container, value, attr){
    container.querySelectorAll('.chip').forEach(ch=>{
      ch.classList.toggle('active', ch.getAttribute(attr) === value);
    });
  }

  // ---------- Ready products & categories ----------
  function rebuildCategorySelects(){
    const cats = new Set(DEFAULT_CATEGORIES);
    allCategories.forEach(c => cats.add(c));
    const sorted = Array.from(cats).filter(Boolean).sort();

    const catSelects = [saleCategory, rCategory];
    catSelects.forEach(sel=>{
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '';
      if(sel === rCategory){
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = '(All)';
        sel.appendChild(optAll);
      }
      sorted.forEach(c=>{
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      });
      if(prev && sorted.includes(prev)){
        sel.value = prev;
      }else if(sel === saleCategory){
        sel.value = 'SFH';
      }
    });
  }

  function buildItemCategories(){
    const set = new Set();
    readyRows.forEach(r=>{
      const ic = (r.item_category || '').trim();
      if(ic) set.add(ic);
    });
    itemCategories = Array.from(set).sort();
    itemCategoryChips.innerHTML = '';
    if(!itemCategories.length){
      const span = document.createElement('div');
      span.className = 'hint';
      span.textContent = 'Define item categories in Ready Products to see them here.';
      itemCategoryChips.appendChild(span);
      currentItemCategory = '';
      return;
    }

    itemCategories.forEach((cat, idx)=>{
      const chip = document.createElement('div');
      chip.className = 'cat-chip';
      chip.textContent = cat;
      chip.dataset.cat = cat;
      if(idx === 0) {
        chip.classList.add('active');
        currentItemCategory = cat;
      }
      chip.addEventListener('click', ()=>{
        currentItemCategory = cat;
        itemCategoryChips.querySelectorAll('.cat-chip').forEach(c=>c.classList.toggle('active', c.dataset.cat === cat));
        renderItemList();
      });
      itemCategoryChips.appendChild(chip);
    });
  }

  async function loadReadyProducts(){
    const d = await fetchJSON('/api/ready_products');
    readyRows = d.rows || [];
    readyIndexByName = {};
    readyIndexByCode = {};
    allCategories = new Set();

    readyRows.forEach(r=>{
      const name = (r.name || '').trim();
      if(!name) return;
      const info = {
        name,
        unit: r.unit,
        price: parseFloat(r.price || 0),
        category: r.category,
        item_category: (r.item_category || '').trim(),
        code: (r.code || '').trim().toUpperCase()
      };
      readyIndexByName[name.toLowerCase()] = info;
      if(info.code && isThreeCharCode(info.code)){
        readyIndexByCode[info.code] = info;
      }
      if(info.category) allCategories.add(info.category);
    });

    rebuildCategorySelects();
    buildItemCategories();
    renderItemList();
  }

  // ---------- Branches & live tables ----------
  async function loadBranches(){
    const d = await fetchJSON('/api/branches');
    const rows = d.rows || [];
    [branchSelect, liveBranch].forEach(sel=>{
      if(!sel) return;
      sel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = '(Select)';
      sel.appendChild(ph);
    });
    rows.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r.name;
      opt.textContent = r.name + (r.is_active==='0'?' (inactive)':'');
      branchSelect.appendChild(opt.cloneNode(true));
      liveBranch.appendChild(opt);
    });
  }

  async function loadLiveTables(){
    const br = liveBranch.value || branchSelect.value || '';
    if(!br){
      liveWrap.innerHTML = '<div class="hint">Select branch to view tables.</div>';
      return;
    }
    const p = new URLSearchParams();
    p.set('period','today');
    p.set('category','SFH');
    p.set('branch', br);
    p.set('payment_status','Live');

    const d = await fetchJSON('/api/sales/report?' + p.toString());
    const rows = d.rows || [];
    const counts = {};
    rows.forEach(r=>{
      const tn = (r.table_no || '—');
      counts[tn] = (counts[tn] || 0) + 1;
    });
    const entries = Object.entries(counts);
    if(!entries.length){
      liveWrap.innerHTML = '<div class="hint">No live orders right now.</div>';
      return;
    }
    const grid = document.createElement('div');
    grid.className = 'table-cards';
    entries.forEach(([table_no,count])=>{
      const card = document.createElement('div');
      card.className = 'tcard';
      card.innerHTML = '<h3>Table ' + table_no + '</h3>' +
                       '<div class="count">' + count + '</div>' +
                       '<div class="hint">Tap to see details (later)</div>';
      grid.appendChild(card);
    });
    liveWrap.innerHTML = '';
    liveWrap.appendChild(grid);
  }

  // ---------- POS: helpers ----------
  function getBillLineForInfo(info){
    return billItems.find(l =>
      l.name === info.name &&
      l.unit === info.unit &&
      Number(l.unit_price) === Number(info.price)
    ) || null;
  }

  function getBillQtyForInfo(info){
    const l = getBillLineForInfo(info);
    return l ? Number(l.qty || 0) : 0;
  }

  function changeItemQty(info, delta){
    let line = getBillLineForInfo(info);
    if(!line && delta > 0){
      line = {
        name: info.name,
        code: info.code,
        item_category: info.item_category,
        unit: info.unit,
        qty: 0,
        unit_price: Number(info.price || 0),
        discount: 0
      };
      billItems.push(line);
    }
    if(!line) return;

    line.qty = Number(line.qty || 0) + delta;
    if(line.qty <= 0){
      billItems = billItems.filter(l => l !== line);
    }
    renderBillItems();
    renderItemList();
    updateTotals();
    updateFloatSummary();
  }

  function renderItemList(){
    itemList.innerHTML = '';
    if(!readyRows.length){
      itemList.innerHTML = '<div class="hint">No ready products yet.</div>';
      return;
    }
    const cat = currentItemCategory;
    const term = (currentItemFilter || '').toLowerCase();

    const rows = readyRows.filter(r=>{
      if(cat && (r.item_category || '').trim() !== cat) return false;
      if(!term) return true;
      const name = (r.name || '').toLowerCase();
      const code = (r.code || '').toLowerCase();
      return name.includes(term) || code.includes(term);
    });

    if(!rows.length){
      itemList.innerHTML = '<div class="hint">No items match this filter.</div>';
      return;
    }

    rows.forEach(r=>{
      const info = readyIndexByName[(r.name || '').toLowerCase()];
      if(!info) return;
      const qty = getBillQtyForInfo(info);

      const row = document.createElement('div');
      row.className = 'item-row';

      const main = document.createElement('div');
      main.className = 'item-main';
      const nm = document.createElement('div');
      nm.className = 'item-name';
      nm.textContent = info.name;
      const meta = document.createElement('div');
      meta.className = 'item-meta';
      const bits = [];
      if(info.code) bits.push(info.code);
      if(info.unit) bits.push(info.unit);
      bits.push(toMoney(info.price));
      if(info.item_category) bits.push(info.item_category);
      meta.textContent = bits.join(' • ');

      main.appendChild(nm);
      main.appendChild(meta);

      const ctrl = document.createElement('div');
      ctrl.className = 'item-ctrl';

      if(qty > 0){
        const pill = document.createElement('div');
        pill.className = 'qty-pill';
        const btnMinus = document.createElement('button');
        btnMinus.type = 'button';
        btnMinus.textContent = '–';
        btnMinus.addEventListener('click', ()=> changeItemQty(info, -1));
        const span = document.createElement('span');
        span.textContent = qty;
        const btnPlus = document.createElement('button');
        btnPlus.type = 'button';
        btnPlus.textContent = '+';
        btnPlus.addEventListener('click', ()=> changeItemQty(info, +1));
        pill.appendChild(btnMinus);
        pill.appendChild(span);
        pill.appendChild(btnPlus);
        ctrl.appendChild(pill);
      }else{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-add';
        btn.textContent = 'ADD';
        btn.addEventListener('click', ()=> changeItemQty(info, +1));
        ctrl.appendChild(btn);
      }

      row.appendChild(main);
      row.appendChild(ctrl);
      itemList.appendChild(row);
    });
  }

  function renderBillItems(){
    billItemsEl
