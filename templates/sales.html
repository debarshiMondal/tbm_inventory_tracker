<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sales / POS - TBM Inventory and Sells Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/main.css">
  <style>
    /* ======== Mobile-first page styles (overrides & additions) ======== */
    :root{
      --accent:#c62828;
      --ink:#111;
      --muted:#666;
      --bg:#f5f5f5;
      --card:#fff;
      --ok:#2e7d32;
      --info:#1976d2;
      --warn:#ef6c00;
    }

    /* tighten header on phones */
    .site-header{ padding:10px 12px; gap:12px; }
    .site-title{ font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .site-nav{ overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; }
    .site-nav a{ padding-bottom:2px; }

    /* sticky section nav under header */
    .section-nav{
      position:sticky; top:56px; z-index:15; background:var(--bg);
      padding:8px 0; margin:8px 0 12px; border-bottom:1px dashed #ddd;
      overflow-x:auto; white-space:nowrap;
    }
    .section-nav a{
      display:inline-block; margin-right:8px; font-size:12px; padding:6px 10px;
      border:1px solid #e0e0e0; border-radius:999px; background:#fff;
    }
    .section-nav a:hover{ border-color:var(--accent); color:var(--accent); }

    /* card extras */
    .card h2{ display:flex; align-items:center; gap:8px; }
    .hint{ color:var(--muted); font-size:11px; }

    /* grid: start stacked, grow as viewport widens */
    .pos-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:10px 12px; }
    .field{ grid-column:span 12; }
    .field.w2{ grid-column:span 6; }
    .field.w3{ grid-column:span 12; }
    .field.w4{ grid-column:span 12; }
    .field.w6{ grid-column:span 12; }
    .field.w8{ grid-column:span 12; }
    .field.w12{ grid-column:span 12; }
    .field label{ display:block; margin:0 0 4px 2px; font-size:12px; color:#444; }
    .field input,.field select,.field textarea{ width:100%; height:44px; font-size:15px; }

    /* quick rows */
    .chipbar{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{
      font-size:13px; padding:8px 12px; border:1px solid #ddd; border-radius:999px;
      background:#fff; cursor:pointer; user-select:none;
    }
    .chip.active{ border-color:var(--accent); color:#fff; background:#var(--accent); }

    .qty-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .qty-row .btn{ padding:10px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; }
    .qty-row .btn:active{ transform:scale(.98); }

    .kpi{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eee; font-size:12px; }
    .kpi b{ color:var(--accent); }

    /* live preview box */
    .totals{
      display:grid; grid-template-columns:1fr auto; gap:6px; background:#fafafa; border:1px dashed #ddd; border-radius:8px; padding:10px 12px;
    }
    .totals .v{ text-align:right; font-weight:600; }
    .totals .grand{ color:#000; font-size:18px; }

    /* floating submit bar (mobile) */
    .float-bar{
      position:sticky; bottom:0; z-index:20; background:rgba(255,255,255,.95);
      border-top:1px solid #eee; backdrop-filter: blur(5px);
      padding:8px 10px; display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .float-bar .summary{ font-size:14px; color:#333; }
    .float-bar .summary b{ color:#000; }
    .float-bar button{ height:44px; padding:0 16px; border-radius:8px; }

    /* table scrolling on phones */
    .table-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-scroll table{ min-width:820px; }

    /* live tables: card layout on phones */
    .table-cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .tcard{ border:1px solid #eee; border-radius:10px; padding:10px 12px; background:#fff; }
    .tcard h3{ margin:0 0 6px; font-size:14px; }
    .tcard .count{ font-size:18px; font-weight:700; color:var(--accent); }

    /* mobile/desktop visibility helpers */
    .hide-on-mobile{ display:none; }
    .show-on-mobile{ display:block; }

    /* read-only input look (unit price) */
    .ro{
      background:#f7f7f7 !important; color:#333;
      border-color:#e0e0e0 !important;
      pointer-events:none;
    }

    /* breakpoints */
    @media (min-width:768px){
      .field.w2{ grid-column:span 2; }
      .field.w3{ grid-column:span 3; }
      .field.w4{ grid-column:span 4; }
      .field.w6{ grid-column:span 6; }
      .field.w8{ grid-column:span 8; }
      .table-cards{ grid-template-columns:repeat(4,1fr); }
      .hide-on-mobile{ display:block; }
      .show-on-mobile{ display:none; }
    }

    /* nicer buttons */
    button{ height:44px; border-radius:8px; }
    .btn-plain{ background:#fff; color:var(--accent); border:1px solid var(--accent); }
    .btn-plain:hover{ background:var(--accent); color:#fff; }
  </style>
</head>
<body>

  <!-- Top header / global nav (from main.css) -->
  <header class="site-header">
    <div class="logo">TBM</div>
    <div class="site-title">TBM Inventory and Sells Tracker</div>
    <nav class="site-nav">
      <a href="/" class="nav-home">Dashboard</a>
      <a href="/ready-products" class="nav-ready">Ready Products</a>
      <a href="/raw-materials" class="nav-raw">Raw Materials</a>
      <a href="/sales" class="nav-sales">Sales</a>
      <a href="/import" class="nav-import">CSV Import/Export</a>
    </nav>
  </header>

  <div class="page-wrap">
    <h1>Sales / POS</h1>

    <div class="section-nav">
      <a href="#add">Add Sale</a>
      <a href="#live">Live Tables</a>
      <a href="#report">Sales Report</a>
    </div>

    <!-- =================== ADD SALE =================== -->
    <section id="add" class="card">
      <h2>Add Sale <span class="kpi">Next Order: <b id="nextOrderKpi">#–</b></span></h2>

      <!-- category + branch -->
      <div class="pos-grid" style="margin-bottom:8px;">
        <div class="field w4">
          <label>Category</label>
          <select id="saleCategory">
            <option>Home Delivery</option>
            <option>Frozen Products</option>
            <option>SFH</option>
          </select>
        </div>

        <div class="field w4" id="sfhBranchWrap" style="display:none;">
          <label>Branch (SFH)</label>
          <div style="display:flex; gap:8px;">
            <select id="branchSelect" style="flex:1 1 auto"></select>
            <button class="btn-plain" type="button" id="addBranchBtn">Add</button>
          </div>
          <div class="hint">Tap “Add” to create a new branch quickly.</div>
        </div>

        <div class="field w4">
          <label>Date</label>
          <input id="saleDate" type="date">
        </div>
      </div>

      <form id="sForm" class="pos-grid" autocomplete="off">
        <!-- New: Item Category filter -->
        <div class="field w4" id="itemCatFilterField">
          <label>Item Category (filter)</label>
          <select id="saleItemCategoryFilter">
            <option value="">(All)</option>
          </select>
          <div class="hint">Optional: pick Momo / Pizza / etc. Then type item name or code.</div>
        </div>

        <div class="field w8">
          <label>Item (from Ready Products)</label>
          <input id="saleItem" list="readyList" placeholder="Type name or 3-char code (e.g. 1CM)..." required>
          <datalist id="readyList"></datalist>
          <div class="hint" id="autoMapHint">
            Type item name or <b>3-char code</b> (1 number + 2 letters, e.g. <code>1CM</code>). Unit &amp; price auto-fill from Ready Products.
          </div>
        </div>

        <div class="field w2">
          <label>Unit</label>
          <select id="saleUnit">
            <option>KG</option><option>GM</option><option>Pieces</option>
            <option>Batch</option><option>Plates</option><option>Portion</option>
          </select>
        </div>

        <div class="field w2">
          <label>Qty</label>
          <input id="saleQty" type="number" inputmode="decimal" step="0.001" placeholder="0">
        </div>

        <div class="field w12">
          <div class="qty-row">
            <button class="btn" type="button" data-q="0.25">+0.25</button>
            <button class="btn" type="button" data-q="0.5">+0.5</button>
            <button class="btn" type="button" data-q="1">+1</button>
            <button class="btn" type="button" id="qtyMinus">–</button>
            <button class="btn" type="button" id="qtyPlus">+</button>
            <button class="btn" type="button" id="qtyClear">Clear</button>
            <span class="hint">Quick qty buttons for faster entry.</span>
          </div>
        </div>

        <div class="field w4">
          <label>Unit Price (auto)</label>
          <input id="saleUnitPrice" class="ro" type="number" inputmode="decimal" step="0.01" placeholder="auto" readonly>
          <div class="hint">Locked to Ready Products price.</div>
        </div>

        <div class="field w4">
          <label>Discount (₹)</label>
          <input id="saleDiscount" type="number" inputmode="decimal" step="0.01" value="0">
          <div class="chipbar" style="margin-top:6px;">
            <div class="chip" data-disc="0">0</div>
            <div class="chip" data-disc="5">5</div>
            <div class="chip" data-disc="10">10</div>
            <div class="chip" data-disc="20">20</div>
            <div class="chip" data-disc="50">50</div>
          </div>
        </div>

        <div class="field w4">
          <label>Table Number</label>
          <input id="saleTable" placeholder="">
        </div>

        <div class="field w6">
          <label>Customer Name</label>
          <input id="saleCustName" placeholder="">
        </div>

        <div class="field w6">
          <label>Customer Phone</label>
          <input id="saleCustPhone" placeholder="" inputmode="tel">
        </div>

        <div class="field w12">
          <label>Payment Status</label>
          <div class="chipbar" id="payChips">
            <div class="chip active" data-status="Live">Live</div>
            <div class="chip" data-status="Due">Due</div>
            <div class="chip" data-status="Paid">Paid</div>
          </div>
        </div>

        <div class="field w6" id="payModeRow" style="display:none;">
          <label>Payment Mode (if Paid)</label>
          <select id="payMode">
            <option value="">Select</option>
            <option value="CurrentUPI">Current a/c UPI</option>
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="PersonalUPI">Personal UPI</option>
            <option value="PersonalCash">Personal Cash</option>
          </select>
        </div>

        <div class="field w6" id="payNoteRow" style="display:none;">
          <label>Payment Note</label>
          <input id="payNote" placeholder="Owner / keeper (for Personal)">
        </div>

        <div class="field w12">
          <label>Notes</label>
          <input id="saleNotes" placeholder="Any remarks…">
        </div>

        <!-- Live bill preview -->
        <div class="field w12">
          <div class="totals">
            <div>Subtotal</div><div class="v" id="tSubtotal">₹0.00</div>
            <div>Discount</div><div class="v" id="tDiscount">₹0.00</div>
            <div class="grand">Total</div><div class="v grand" id="tTotal">₹0.00</div>
          </div>
        </div>

        <div class="field w12">
          <button id="submitSale" type="submit">Record Sale &amp; Generate Bill</button>
        </div>
      </form>

      <div class="float-bar" id="floatBar">
        <div class="summary">Order <b id="floatOrder">#–</b> • Total <b id="floatTotal">₹0.00</b></div>
        <div style="display:flex; gap:8px;">
          <button class="btn-plain" type="button" id="clearFormBtn">Clear</button>
          <button type="button" id="submitBarBtn">Save &amp; Bill</button>
        </div>
      </div>

      <p class="hint">Stock reduces from <b>Ready Products</b> instantly. The bill opens in a new tab (you can print/share PDF).</p>
    </section>

    <!-- =================== LIVE TABLES (SFH) =================== -->
    <section id="live" class="card">
      <h2>Live Tables (SFH)</h2>
      <div class="pos-grid" style="margin-bottom:8px;">
        <div class="field w6">
          <label>Branch</label>
          <select id="liveBranch"></select>
        </div>
        <div class="field w6">
          <label>&nbsp;</label>
          <button id="refreshLive" class="btn-plain" type="button">Refresh</button>
        </div>
      </div>

      <div id="liveWrap">
        <div class="hint">Pick an SFH branch to see current live orders per table.</div>
      </div>
    </section>

    <!-- =================== SALES REPORT =================== -->
    <section id="report" class="card">
      <h2>Sales Records &amp; Report</h2>

      <!-- Mobile notice -->
      <div class="show-on-mobile hint" style="margin-bottom:8px;">
        Mobile view shows <b>Today</b> only. Detailed record table is hidden for a faster POS workflow.
      </div>

      <div class="pos-grid">
        <div class="field w3">
          <label>Period</label>
          <select id="rPeriod">
            <option value="last30">Last 30 days</option>
            <option value="last90">Last 90 days</option>
            <option value="last180">Last 180 days</option>
            <option value="month">This month</option>
            <option value="week">This week</option>
            <option value="today" selected>Today</option>
            <option value="daterange">Date range…</option>
          </select>
        </div>
        <div class="field w3 hide-on-mobile">
          <label>Start</label>
          <input id="rStart" type="date">
        </div>
        <div class="field w3 hide-on-mobile">
          <label>End</label>
          <input id="rEnd" type="date">
        </div>
        <div class="field w3 hide-on-mobile">
          <label>Category</label>
          <select id="rCategory">
            <option value="">(All)</option>
            <option>Home Delivery</option>
            <option>Frozen Products</option>
            <option>SFH</option>
          </select>
        </div>
        <div class="field w4 hide-on-mobile">
          <label>Branch (SFH)</label>
          <input id="rBranch" placeholder="">
        </div>
        <div class="field w4 hide-on-mobile">
          <label>Item</label>
          <input id="rItem" placeholder="">
        </div>
        <div class="field w4 hide-on-mobile">
          <label>Status</label>
          <select id="rStatus">
            <option value="">(All)</option>
            <option>Live</option>
            <option>Due</option>
            <option>Paid</option>
          </select>
        </div>
        <div class="field w12">
          <button id="runReport" type="button">Run</button>
        </div>

        <div class="field w12">
          <div class="kpi" id="reportSummary">Total: ₹0.00</div>
        </div>

        <div class="field w12">
          <div class="row" style="gap:14px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0 0 6px;">By Category</h3>
              <div class="table-scroll"><table id="tblCat"><tr><th>Category</th><th>Sales</th></tr></table></div>
            </div>
            <div>
              <h3 style="margin:0 0 6px;">By Item</h3>
              <div class="table-scroll"><table id="tblItem"><tr><th>Item</th><th>Sales</th></tr></table></div>
            </div>
            <div>
              <h3 style="margin:0 0 6px;">By Branch</h3>
              <div class="table-scroll"><table id="tblBranch"><tr><th>Branch</th><th>Sales</th></tr></table></div>
            </div>
            <!-- Mobile-only: By Payment Mode -->
            <div class="show-on-mobile">
              <h3 style="margin:0 0 6px;">By Payment Mode (Today)</h3>
              <div class="table-scroll"><table id="tblPayMode"><tr><th>Mode</th><th>Sales</th><th>Count</th></tr></table></div>
            </div>
          </div>
        </div>

        <!-- Detailed Records (hidden on mobile) -->
        <div class="field w12 hide-on-mobile" id="detailBlock">
          <h3 style="margin:10px 0 6px;">Detailed Records</h3>
          <div class="table-scroll">
            <table id="tblDetail">
              <tr>
                <th>Date</th><th>Category</th><th>Branch</th><th>Order</th>
                <th>Item</th><th>Unit</th><th>Qty</th><th>Unit Price</th>
                <th>Discount</th><th>Total</th><th>Customer</th><th>Phone</th>
                <th>Table</th><th>Status</th><th>Mode</th><th>Pay Note</th><th>Notes</th>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">TBM Inventory and Sells Tracker — CSV based, simple, fast.</div>
  </div>

  <script src="/static/ui.js"></script>
  <script>
    document.querySelector('.nav-sales')?.classList.add('active');

    // ---------- Elements ----------
    const nextOrderKpi = document.getElementById('nextOrderKpi');
    const floatOrder   = document.getElementById('floatOrder');
    const floatTotal   = document.getElementById('floatTotal');

    const saleCategory = document.getElementById('saleCategory');
    const sfhBranchWrap= document.getElementById('sfhBranchWrap');
    const branchSelect = document.getElementById('branchSelect');
    const addBranchBtn = document.getElementById('addBranchBtn');
    const saleDate     = document.getElementById('saleDate');

    const saleItemCategoryFilter = document.getElementById('saleItemCategoryFilter');
    const itemCatFilterField     = document.getElementById('itemCatFilterField');

    const saleItem     = document.getElementById('saleItem');
    const readyList    = document.getElementById('readyList');
    const saleUnit     = document.getElementById('saleUnit');
    const saleQty      = document.getElementById('saleQty');
    const saleUnitPrice= document.getElementById('saleUnitPrice');
    const saleDiscount = document.getElementById('saleDiscount');
    const saleTable    = document.getElementById('saleTable');
    const saleCustName = document.getElementById('saleCustName');
    const saleCustPhone= document.getElementById('saleCustPhone');
    const saleNotes    = document.getElementById('saleNotes');

    const payChips     = document.getElementById('payChips');
    const payModeRow   = document.getElementById('payModeRow');
    const payNoteRow   = document.getElementById('payNoteRow');
    const payMode      = document.getElementById('payMode');
    const payNote      = document.getElementById('payNote');

    const chipDiscBtns = document.querySelectorAll('.chip[data-disc]');
    const qtyRow       = document.querySelector('.qty-row');

    const tSub   = document.getElementById('tSubtotal');
    const tDisc  = document.getElementById('tDiscount');
    const tTotal = document.getElementById('tTotal');

    const floatBar     = document.getElementById('floatBar');
    const submitBarBtn = document.getElementById('submitBarBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const sForm        = document.getElementById('sForm');

    // Live tables
    const liveBranch   = document.getElementById('liveBranch');
    const refreshLive  = document.getElementById('refreshLive');
    const liveWrap     = document.getElementById('liveWrap');

    // Report
    const rPeriod  = document.getElementById('rPeriod');
    const rStart   = document.getElementById('rStart');
    const rEnd     = document.getElementById('rEnd');
    const rCategory= document.getElementById('rCategory');
    const rBranch  = document.getElementById('rBranch');
    const rItem    = document.getElementById('rItem');
    const rStatus  = document.getElementById('rStatus');
    const runReportBtn = document.getElementById('runReport');
    const reportSummary= document.getElementById('reportSummary');
    const tblCat   = document.getElementById('tblCat');
    const tblItem  = document.getElementById('tblItem');
    const tblBranch= document.getElementById('tblBranch');
    const tblDetail= document.getElementById('tblDetail');
    const tblPayMode = document.getElementById('tblPayMode');

    // ---------- State ----------
    let readyRows = [];  // full raw rows from backend
    let readyIndex = {}; // name_lower -> info
    let readyCodeIndex = {}; // 3-char code (upper) -> info
    let payStatus  = 'Live';

    // ---------- Utils ----------
    const toMoney = (n)=> '₹' + (Number(n||0).toFixed(2));
    const isMobile = ()=> window.matchMedia('(max-width: 767px)').matches;

    function setChipsActive(container, value, keyAttr){
      container.querySelectorAll('.chip').forEach(ch=>{
        ch.classList.toggle('active', ch.getAttribute(keyAttr) === value);
      });
    }

    function isThreeCharCode(val){
      // exactly 3 chars: 1 digit + 2 letters (case-insensitive)
      return /^[0-9][A-Za-z]{2}$/.test(val);
    }

    // ---------- Loaders ----------
    async function loadNextOrder(){
      try{
        const d = await fetchJSON('/api/sales/next_order');
        nextOrderKpi.textContent = '#' + d.next_order_id;
        floatOrder.textContent   = '#' + d.next_order_id;
      }catch{}
    }

    function rebuildItemCategoryFilter(){
      if(!saleItemCategoryFilter) return;
      const catSet = new Set();
      readyRows.forEach(r=>{
        const ic = (r.item_category || '').trim();
        if(ic) catSet.add(ic);
      });

      saleItemCategoryFilter.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = '(All)';
      saleItemCategoryFilter.appendChild(optAll);

      if(catSet.size === 0){
        // nothing to filter -> hide the field
        if(itemCatFilterField) itemCatFilterField.style.display = 'none';
        return;
      }
      if(itemCatFilterField) itemCatFilterField.style.display = '';

      Array.from(catSet).sort().forEach(cat=>{
        const o = document.createElement('option');
        o.value = cat;
        o.textContent = cat;
        saleItemCategoryFilter.appendChild(o);
      });
    }

    function rebuildReadyOptions(){
      readyList.innerHTML = '';
      const filterCat = saleItemCategoryFilter ? (saleItemCategoryFilter.value || '') : '';

      readyRows.forEach(r=>{
        const name = (r.name || '').trim();
        if(!name) return;

        const ic = (r.item_category || '').trim();
        if(filterCat && ic !== filterCat) return;

        const code = (r.item_code || '').trim();
        const unit = (r.unit || '').trim();
        const price = Number(r.price || 0);

        const opt = document.createElement('option');
        opt.value = name;

        const bits = [];
        if(code) bits.push(code);
        bits.push(name);
        if(unit) bits.push(`${unit} @ ₹${price.toFixed(2)}`);
        if(ic) bits.push(`(${ic})`);

        opt.label = bits.join(' • ');
        readyList.appendChild(opt);
      });
    }

    async function loadReadyProducts(){
      const d = await fetchJSON('/api/ready_products');
      readyRows = d.rows || [];
      readyIndex = {};
      readyCodeIndex = {};

      readyRows.forEach(r=>{
        const name = (r.name || '').trim();
        if(!name) return;
        const keyName = name.toLowerCase();
        const info = {
          name,
          unit: r.unit,
          price: parseFloat(r.price || 0),
          category: r.category,
          item_category: (r.item_category || '').trim(),
          item_code: (r.item_code || '').trim()
        };
        readyIndex[keyName] = info;

        const code = info.item_code;
        if(code && isThreeCharCode(code)){
          readyCodeIndex[code.toUpperCase()] = info;
        }
      });

      rebuildItemCategoryFilter();
      rebuildReadyOptions();
    }

    async function loadBranches(){
      const d = await fetchJSON('/api/branches');
      const rows = d.rows||[];
      [branchSelect, liveBranch].forEach(sel=>{
        sel.innerHTML='';
        const ph = document.createElement('option');
        ph.value=''; ph.textContent='(Select)';
        sel.appendChild(ph);
      });
      rows.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.name;
        opt.textContent = r.name + (r.is_active==='0'?' (inactive)':'');
        branchSelect.appendChild(opt.cloneNode(true));
        liveBranch.appendChild(opt);
      });
    }

    // ---------- UI logic ----------
    function applyItemDefaults(){
      const val = saleItem.value.trim();
      if(!val) return;
      const info = readyIndex[val.toLowerCase()];
      if(!info) return;

      saleUnit.value = info.unit || saleUnit.value;
      saleUnitPrice.value = Number(info.price || 0).toFixed(2);
      if(!saleCategory.value) saleCategory.value = info.category || 'Home Delivery';

      // If this item has an item_category and our filter is empty, we can pre-select it
      if(info.item_category && saleItemCategoryFilter && !saleItemCategoryFilter.value){
        saleItemCategoryFilter.value = info.item_category;
      }

      updateTotals();
    }

    function updateTotals(){
      const qty = Number(saleQty.value || 0);
      const up  = Number(saleUnitPrice.value || 0);
      const disc= Number(saleDiscount.value || 0);
      const sub = qty * up;
      const tot = Math.max(0, sub - disc);

      tSub.textContent   = toMoney(sub);
      tDisc.textContent  = toMoney(disc);
      tTotal.textContent = toMoney(tot);
      floatTotal.textContent = toMoney(tot);
    }

    function toggleSFH(){
      const isSFH = (saleCategory.value === 'SFH');
      sfhBranchWrap.style.display = isSFH ? '' : 'none';
    }

    function togglePay(){
      const paid = (payStatus === 'Paid');
      payModeRow.style.display = paid ? '' : 'none';
      const needsNote = paid && (payMode.value==='PersonalUPI' || payMode.value==='PersonalCash');
      payNoteRow.style.display = needsNote ? '' : 'none';
    }

    // quick qty handlers
    qtyRow?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn');
      if(!btn) return;
      if(btn.id==='qtyPlus'){ saleQty.value = Number(saleQty.value||0) + 1; updateTotals(); return; }
      if(btn.id==='qtyMinus'){ saleQty.value = Math.max(0, Number(saleQty.value||0) - 1); updateTotals(); return; }
      if(btn.id==='qtyClear'){ saleQty.value=''; updateTotals(); return; }
      const inc = Number(btn.dataset.q||0);
      saleQty.value = Number(saleQty.value||0) + inc;
      updateTotals();
    });

    // discount chips
    chipDiscBtns.forEach(b=> b.addEventListener('click', ()=>{
      chipDiscBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      saleDiscount.value = b.dataset.disc;
      updateTotals();
    }));

    // pay chips
    payChips.addEventListener('click', (e)=>{
      const c = e.target.closest('.chip'); if(!c) return;
      payStatus = c.dataset.status;
      setChipsActive(payChips, payStatus, 'data-status');
      togglePay();
    });
    payMode.addEventListener('change', togglePay);

    // SFH toggle
    saleCategory.addEventListener('change', ()=>{
      toggleSFH();
      if(saleCategory.value==='SFH' && branchSelect.value){
        liveBranch.value = branchSelect.value;
        loadLiveTables();
      }
    });

    // Item Category filter change
    saleItemCategoryFilter?.addEventListener('change', ()=>{
      rebuildReadyOptions();
      // clearing item box keeps new filter effective
      saleItem.value = '';
      saleUnitPrice.value = '';
      updateTotals();
    });

    // smart item selection: name or 3-char code
    saleItem.addEventListener('input', ()=>{
      const val = saleItem.value.trim();
      if(isThreeCharCode(val)){
        const info = readyCodeIndex[val.toUpperCase()];
        if(info){
          // direct select by code
          saleItem.value = info.name;
          if(saleItemCategoryFilter && info.item_category){
            saleItemCategoryFilter.value = info.item_category;
            rebuildReadyOptions();
          }
          saleUnit.value = info.unit || saleUnit.value;
          saleUnitPrice.value = Number(info.price || 0).toFixed(2);
          if(!saleCategory.value) saleCategory.value = info.category || 'Home Delivery';
          updateTotals();
          return;
        }
      }
      // if not a complete code, just recalc totals when name later chosen
    });

    // also apply defaults when user picks from datalist
    saleItem.addEventListener('change', applyItemDefaults);

    saleQty.addEventListener('input', updateTotals);
    saleDiscount.addEventListener('input', ()=>{
      chipDiscBtns.forEach(x=>x.classList.remove('active'));
      updateTotals();
    });

    // add branch
    addBranchBtn.addEventListener('click', async ()=>{
      const name = prompt('New branch name?'); if(!name) return;
      await fetchJSON('/api/branches', {method:'POST', body: JSON.stringify({name, is_active:true})});
      await loadBranches();
      branchSelect.value = name; liveBranch.value = name;
      loadLiveTables();
    });

    // Live tables
    async function loadLiveTables(){
      const br = liveBranch.value || branchSelect.value || '';
      if(!br){
        liveWrap.innerHTML = '<div class="hint">Select branch to view tables.</div>';
        return;
      }
      const d = await fetchJSON(`/api/branch_tables?branch=${encodeURIComponent(br)}&status=Live`);
      const rows = d.rows||[];
      if(!rows.length){
        liveWrap.innerHTML = '<div class="hint">No live orders right now.</div>';
        return;
      }
      const grid = document.createElement('div');
      grid.className = 'table-cards';
      rows.forEach(r=>{
        const card = document.createElement('div');
        card.className = 'tcard';
        card.innerHTML = `<h3>Table ${r.table_no}</h3><div class="count">${r.open_orders}</div>`;
        grid.appendChild(card);
      });
      liveWrap.innerHTML=''; liveWrap.appendChild(grid);
    }
    refreshLive.addEventListener('click', loadLiveTables);
    liveBranch.addEventListener('change', loadLiveTables);

    // Submit
    async function submitSale(){
      applyItemDefaults();
      updateTotals();
      const category = saleCategory.value || 'Home Delivery';
      const payload = {
        date: saleDate.value || null,
        category,
        branch: category==='SFH' ? (branchSelect.value||'') : '',
        item: (saleItem.value||'').trim(),
        unit: saleUnit.value,
        qty: Number(saleQty.value||0),
        unit_price: null,  // backend uses Ready Products price
        discount: Number(saleDiscount.value||0),
        customer_name: (saleCustName.value||'').trim(),
        customer_phone: (saleCustPhone.value||'').trim(),
        table_no: (saleTable.value||'').trim(),
        payment_status: payStatus,
        payment_mode: payStatus==='Paid' ? (payMode.value||'') : '',
        payment_note: (payNote.value||'').trim(),
        notes: (saleNotes.value||'').trim()
      };
      if(!payload.item){ alert('Please choose an item.'); return; }
      if(payload.qty<=0){ alert('Quantity must be > 0'); return; }

      const res = await fetchJSON('/api/sales', {method:'POST', body: JSON.stringify(payload)});
      if(res.bill_url){ window.open(res.bill_url, '_blank'); }
      await Promise.all([loadNextOrder(), runReport()]);
      const keepCat = saleCategory.value;
      const keepBr  = branchSelect.value;
      sForm.reset();
      saleCategory.value = keepCat;
      branchSelect.value = keepBr;
      toggleSFH(); setChipsActive(payChips,'Live','data-status'); payStatus='Live'; togglePay();
      updateTotals();
      loadLiveTables();
    }
    sForm.addEventListener('submit', (e)=>{ e.preventDefault(); submitSale(); });
    submitBarBtn.addEventListener('click', submitSale);
    clearFormBtn.addEventListener('click', ()=>{
      sForm.reset();
      if(saleItemCategoryFilter){
        saleItemCategoryFilter.value = '';
        rebuildReadyOptions();
      }
      updateTotals();
    });

    // ---------- Report ----------
    function lockReportToTodayOnMobile(){
      if(!isMobile()) return;
      rPeriod.value = 'today';
      rPeriod.disabled = true;
      if(rStart) rStart.disabled = true;
      if(rEnd) rEnd.disabled = true;
      if(rCategory) rCategory.disabled = true;
      if(rBranch) rBranch.disabled = true;
      if(rItem) rItem.disabled = true;
      if(rStatus) rStatus.disabled = true;
    }

    function fillTable(tbl, obj){
      const header = tbl.querySelector('tr').outerHTML;
      tbl.innerHTML = header;
      Object.entries(obj||{}).forEach(([k,v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k||'—'}</td><td>${toMoney(v)}</td>`;
        tbl.appendChild(tr);
      });
    }

    function fillPayModeTable(rows){
      if(!tblPayMode) return;
      const header = tblPayMode.querySelector('tr').outerHTML;
      tblPayMode.innerHTML = header;
      const agg = {};
      const cnt = {};
      (rows||[]).forEach(r=>{
        const m = r.payment_mode || (r.payment_status==='Paid' ? '(unknown)' : '(not paid)');
        const amt = Number(r.total_price||0);
        agg[m] = (agg[m]||0) + amt;
        cnt[m] = (cnt[m]||0) + 1;
      });
      Object.keys(agg).forEach(k=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${toMoney(agg[k])}</td><td>${cnt[k]||0}</td>`;
        tblPayMode.appendChild(tr);
      });
    }

    async function runReport(){
      const p = new URLSearchParams();
      p.set('period', rPeriod.value);
      if(rPeriod.value==='daterange'){
        if(rStart.value) p.set('start',rStart.value);
        if(rEnd.value) p.set('end',rEnd.value);
      }
      if(!isMobile()){
        if(rCategory?.value) p.set('category', rCategory.value);
        if(rBranch?.value?.trim()) p.set('branch', rBranch.value.trim());
        if(rItem?.value?.trim()) p.set('item', rItem.value.trim());
        if(rStatus?.value) p.set('payment_status', rStatus.value);
      }else{
        p.set('period','today');
      }

      const d = await fetchJSON('/api/sales/report?'+p.toString());
      reportSummary.textContent = `Total: ${toMoney(d.total_sales)} (from ${d.period.start} to ${d.period.end})`;

      fillTable(tblCat, d.by_category||{});
      fillTable(tblItem, d.by_item||{});
      fillTable(tblBranch, d.by_branch||{});

      if(isMobile()){
        fillPayModeTable(d.rows||[]);
      }

      if(!isMobile()){
        tblDetail.innerHTML = `
          <tr>
            <th>Date</th><th>Category</th><th>Branch</th><th>Order</th>
            <th>Item</th><th>Unit</th><th>Qty</th><th>Unit Price</th>
            <th>Discount</th><th>Total</th><th>Customer</th><th>Phone</th>
            <th>Table</th><th>Status</th><th>Mode</th><th>Pay Note</th><th>Notes</th>
          </tr>`;
        (d.rows||[]).forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td><td>${r.category||''}</td><td>${r.branch||''}</td><td>${r.order_id||''}</td>
            <td>${r.item||''}</td><td>${r.unit||''}</td><td>${r.qty||''}</td><td>${r.unit_price||''}</td>
            <td>${r.discount||''}</td><td>${r.total_price||''}</td><td>${r.customer_name||''}</td><td>${r.customer_phone||''}</td>
            <td>${r.table_no||''}</td><td>${r.payment_status||''}</td><td>${r.payment_mode||''}</td><td>${r.payment_note||''}</td><td>${r.notes||''}</td>`;
          tblDetail.appendChild(tr);
        });
      }
    }
    runReportBtn.addEventListener('click', runReport);

    // ---------- Init ----------
    (async function init(){
      try{ saleDate.valueAsDate = new Date(); }catch{}
      await Promise.all([loadNextOrder(), loadReadyProducts(), loadBranches()]);
      toggleSFH(); togglePay(); updateTotals();
      liveBranch.value = branchSelect.value || '';
      lockReportToTodayOnMobile();
      await runReport();
      if(liveBranch.value) loadLiveTables();
    })();
  </script>
</body>
</html>
